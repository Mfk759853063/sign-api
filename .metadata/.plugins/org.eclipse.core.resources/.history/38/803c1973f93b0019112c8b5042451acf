package com.porui.hjl.app.device.socketServer.mina;

import java.util.HashMap;
import java.util.Set;
import java.util.Timer;
import java.util.TimerTask;
import java.util.Map.Entry;

import org.apache.mina.core.service.IoHandlerAdapter;
import org.apache.mina.core.session.IoSession;
import org.apache.mina.filter.codec.ProtocolCodecFilter;

import com.porui.hjl.app.device.properties.AppContext;

/**
 * Created by tablv on 2018-03-23.
 * 
 * @Description:分包传数据（每个包前面4个byte为长度）
 */

public class NewCentralSokectServer extends MinaSocketServer {

	private static NewCentralSokectServer newCentralSokectServer = null;	
	/**
	 * key：房间中控Mac,value:socket连接sessionID
	 */
	private HashMap<String, Long> clients = new HashMap<>();

	public static NewCentralSokectServer getInstance() {
		if (null == newCentralSokectServer) {
			newCentralSokectServer = new NewCentralSokectServer();
		}
		return newCentralSokectServer;
	}
	
	@Override
	public boolean start() {
		try {
			String port = AppContext.getInstance().getProperty("nwsocketPort");
			startServer(port, new IoHandlerAdapter() {
				@Override
				public void exceptionCaught(IoSession session, Throwable cause) throws Exception {
					super.exceptionCaught(session, cause);
					logger.error("exceptionCaught===", cause);
				}

				@Override
				public void sessionClosed(IoSession session) throws Exception {
					super.sessionClosed(session);
					logger.info("sessionClosed ： Remove  clients--> "+session.getAttribute("central"));
					
				}

				@Override
				public void messageReceived(IoSession session, Object message) throws Exception {					
					
					try {
						
						String reMsg = new String((byte[])message, "utf-8");						
						boolean isAndroid=false;
						if(reMsg.endsWith("android")){
							reMsg=reMsg.substring(0, reMsg.length()-7);
							isAndroid=true;
						}
						
						logger.info("messageReceived ..................msg : "+reMsg );
						
						// 中控设备登记
						if (reMsg.endsWith("address")) {
							reMsg=reMsg.toLowerCase();
							logger.info("Centrl register ok  : "+reMsg +" : "+session.getId());
							session.setAttribute("central", reMsg);						
							session.setAttribute("isAndroid", isAndroid);
							clients.put(reMsg, session.getId());						
						}else{
							String central = (String) session.getAttribute("central");
							// 中控消息接收
							if(reMsg.startsWith("hjlbl")){							
								for(String appPre:AppSocketServer.MAC_APP_PRE){
									sendMessage2AppClient(appPre + central, reMsg);
									Thread.sleep(50);
								}							
							}						
						}
					} catch (Exception e) {
						logger.info(" messageReceived Exception ",e);
					}
					
				}

				@Override
				public void sessionOpened(IoSession session) throws Exception {
					logger.info("messageReceived sessionOpened。。。。。。。。。。。。。。。。。。。。");
				}
				
				
			});		
			
			if(timer==null){
				timer=new Timer(true);
			}
			String heartBeatTimeoutSecs = AppContext.getInstance().getProperty("heartBeatTimeoutSecs");
			timer.schedule(new TimerTask() {
				
				@Override
				public void run() {
					try {
						checkAndSendHeartPKG("newcentral");
					} catch (Exception e) {
						logger.error("----sendAndroidCentral Exception--------");
					}					
				}
			}, 10000, Integer.parseInt(heartBeatTimeoutSecs) * 1000);
			
			working = true;
			logger.info("NewCentralSokectServer launcher port:" + port);
			return true;
		} catch (Exception e) {
			logger.error("==start Exception==", e);
		}
		return false;
	}
	
	private void checkAndSendHeartPKG(String msg) throws Exception{
    	Set<Entry<Long, IoSession>> entrySet = acceptor.getManagedSessions().entrySet();
		for (Entry<Long, IoSession> entry : entrySet) {			
			IoSession iosession = entry.getValue();
			if(null!=iosession){
				String zkMac = (String)iosession.getAttribute("central", null);
				if(null!=zkMac&&clients.containsKey(zkMac)){					
					boolean isAndroid=(boolean)iosession.getAttribute("isAndroid", false);
					logger.info("find session zkMac : "+zkMac+" isAndroid : "+isAndroid);
					if(isAndroid){
						iosession.write(msg.getBytes());
					}
				}else{
					logger.info("this session is illegal connection  "+zkMac+" : "+iosession.getId());
					iosession.closeNow();
				}			
			}else{
				logger.info("sendAndroidCentral iosession is null.......");
			}
		}
	}
	

	@Override
	public ProtocolCodecFilter getProtocolCodecFilter() {
		
		return new ProtocolCodecFilter(new BatchByteCodecFactory());
	}
	
	private boolean sendMessage2AppClient(String room, String content) {
		boolean result=AppSocketServer.getInstance().sendMessage(room, content);
		return result;
	}
	
	public boolean sendMessage(String groupName, String content) throws Exception{		
		logger.info("sendMessage content  groupName:" + groupName + " content:" + content);
		byte[] bytes = content.getBytes();	
		return sendMessage(groupName, bytes);
	}

	
	  /** 
	   * @Description 方法的作用
	   * @param 参数
	   * @return 返回类型
	   * @throws
	   */ 
        private boolean sendMessage(String groupName, byte[] bytes) throws Exception{
		//logger.info("sendMessage byte[]....."+MD5.byteArrayToHexString(bytes));
		if (!working) {
			logger.info("socket server is closed..........groupName : " + groupName);
			return false;
		}
		if(null!=groupName){
			groupName=groupName.toLowerCase();			
		}
		try {
			if ("@all".equals(groupName)) {
				//sendMsg2AllClients(bytes);
			} else {
	            Long sessionId = clients.get(groupName);
	            logger.info("send messge..........groupName ：sessionId : " +groupName+" : "+sessionId);
	            if(null!=sessionId){
	            	IoSession ioSession = acceptor.getManagedSessions().get(sessionId);
	            	logger.info("send messge..........ioSession : " + ioSession+" bytes.size : "+bytes.length);
	            	if(null!=ioSession){	            	
	            		ioSession.write(bytes);            		
	            	}else{
	            		return false;
	            	}
	            }else{
	            	return false;
	            }
			}
			return true;
		} catch (Exception e) {
			logger.error("== sendMessage Exception ==", e);
		}		
		
		return false;
			
	}
	

}
